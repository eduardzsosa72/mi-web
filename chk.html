<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHK VISA-MASTER - Tema Scarlet</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variáveis de Cores: Tema SCARLET PROFUNDO */
        :root {
            --primary-color: #DC143C; /* Vermelho Escarlate Vibrante */
            --primary-dark: #A50022; /* Vermelho mais escuro para hover */
            --success-color: #28a745; /* Verde para Aprovado (manter alto contraste) */
            --danger-color: var(--primary-color); /* Usar o primário para Erro/Dead */
            --warning-color: #ffc107;
            --bg-dark: #212529; /* Fundo do Log e Cabeçalhos de Tabela */
            --bg-body: #f1f1ff; /* Cinza muito claro */
            --card-bg: #ffffff;
            --text-dark: #343a40;
            --text-light: #f8f9fa;
            --shadow-subtle: rgba(220, 20, 60, 0.15); /* Sombra com toque de vermelho */
            --border-light: #e0e0e0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1300px;
            margin: 0 auto;
            background-color: var(--card-bg);
            border-radius: 12px; /* Cantos mais arredondados */
            box-shadow: 0 8px 20px var(--shadow-subtle);
            padding: 30px;
        }

        h1 {
            color: var(--primary-color) !important;
            font-weight: 900;
            text-transform: uppercase;
        }

        /* ------------------ Abas de Navegação ------------------ */
        .tabs {
            display: flex;
            border-bottom: 3px solid var(--border-light);
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .tab-button {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 700;
            color: #6c757d;
            transition: color 0.3s ease, border-bottom 0.3s ease;
            white-space: nowrap;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom: 4px solid var(--primary-color);
            font-weight: 900;
        }

        .tab-button:not(.active):hover {
            color: var(--primary-dark);
        }

        /* Cores de status nos botões */
        #tab-live span, #tab-dead span {
            padding: 4px 10px;
            margin-left: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 700;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        #tab-live span { background-color: var(--success-color); color: white; }
        #tab-dead span { background-color: var(--danger-color); color: white; }
        #tab-checking span { background-color: var(--warning-color); color: var(--text-dark); }

        .tab-content { display: none; padding: 10px 0; }
        .tab-content.active { display: block; }

        /* ------------------ Layout dos Conteúdos ------------------ */
        .input-area, .checking-dashboard, .results-panel {
            padding: 25px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-top: 15px;
            background-color: var(--bg-body);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* Aba: Para Pôr os Cartões */
        #input-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }
        #card-list {
            width: 100%;
            min-height: 250px;
            padding: 15px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            resize: vertical;
            font-family: 'Roboto Mono', monospace; /* Fonte monoespaçada mais limpa */
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }
        #card-list:focus {
            border-color: var(--primary-color); /* Foco no Vermelho */
            outline: none;
        }
        .input-controls h3 {
            margin-top: 0;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }
        .input-controls button {
            width: 100%;
            padding: 14px;
            margin-top: 15px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #start-check {
            background-color: var(--primary-color);
            color: white;
        }
        #start-check:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Estilo para o botão de Parar */
        #stop-check {
            background-color: #f0ad4e; /* Laranja de Aviso */
            color: white;
        }
        #stop-check:hover {
            background-color: #ec971f;
            transform: translateY(-2px);
        }

        #clear-list {
            background-color: var(--secondary-color);
            color: white;
            background-color: #6c757d;
        }
        #clear-list:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        .format-example {
            margin-top: 20px;
            padding: 15px;
            background-color: #f7e0e3; /* Fundo claro com toque de vermelho */
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-dark);
        }

        /* Aba: Testando em Tempo Real */
        .status-bar {
            display: flex;
            justify-content: space-between;
            background: linear-gradient(90deg, #1c1c1c, var(--bg-dark)); /* Gradiente sutil */
            color: var(--text-light);
            padding: 20px 30px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .status-item {
            text-align: center;
        }
        .status-value {
            font-size: 2.2rem;
            font-weight: 900;
            line-height: 1;
        }
        .status-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            opacity: 0.8;
            margin-top: 5px;
        }

        .realtime-log {
            min-height: 350px;
            max-height: 450px;
            overflow-y: scroll;
            background-color: #1a1a1a; /* Fundo preto puro para o log */
            color: #e0e0e0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            border: 1px solid #444;
        }

        /* Aba: Resultados (Tabelas) */
        .results-panel {
            padding: 15px; /* Reduzido levemente */
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-top: 15px;
            background-color: var(--bg-body);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .results-table th, .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }
        .results-table th {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-weight: 700;
        }
        .results-table tr:nth-child(even) { /* Zebra striping para melhor leitura */
            background-color: #f8f9fa; 
        }
        .results-table tr:hover {
            background-color: #fcebeb; /* Levemente vermelho no hover */
        }

        /* Botão de Copiar Todos */
        #copy-all-live {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            background-color: var(--success-color);
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #copy-all-live:hover {
            background-color: #218838;
            transform: translateY(-1px);
        }


        /* Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px; /* Pill shape */
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .live-badge { background-color: var(--success-color); }
        .dead-badge { 
            background-color: var(--danger-color); 
            border: 1px solid var(--primary-dark);
        }
        .error-badge { background-color: var(--warning-color); color: var(--text-dark); }
        
        /* Responsividade básica (manter) */
        @media (max-width: 768px) {
            #input-content {
                grid-template-columns: 1fr;
            }
            .status-bar {
                flex-wrap: wrap;
                gap: 15px;
                justify-content: space-around;
            }
        }

        /* Pulse Animation for Counters */
        @keyframes pulse-success {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        @keyframes pulse-danger {
            0% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(220, 20, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0); }
        }
        .success-pulse { animation: pulse-success 0.5s ease-out; }
        .danger-pulse { animation: pulse-danger 0.5s ease-out; }
    </style>
</head>
<body>
    <div class="dashboard-container">
    <header>
        <h1 style="color: var(--primary-color); margin-bottom: 10px;">888 ELITE </h1>
    </header>

    <div class="tabs">
        <button class="tab-button active" data-tab="input-content" id="tab-input">
            <i class="fas fa-list-alt"></i> Pôr Cartões para Testar
        </button>
        <button class="tab-button" data-tab="checking-content" id="tab-checking">
            <i class="fas fa-spinner fa-spin"></i> Testando em Tempo Real <span id="checking-span">0</span>
        </button>
        <button class="tab-button" data-tab="live-content" id="tab-live">
            <i class="fas fa-check-circle"></i> Aprovados (Live) <span id="live-span">0</span>
        </button>
        <button class="tab-button" data-tab="dead-content" id="tab-dead">
            <i class="fas fa-times-circle"></i> Reprovados (Dead/Erro) <span id="dead-span">0</span>
        </button>
    </div>

    <div class="tab-content active" id="input-content">
        <div class="input-area">
            <h3>Lista de Cartões para Testar</h3>
            <textarea id="card-list" placeholder="Cole a lista de cartões aqui. Um por linha. Ex: Número|Mês|Ano|CVV"></textarea>
            <div class="format-example">
                **Formato esperado:** `1234567890123456|12|2027|123`
                <br>
                **O CVV agora aceita letras e símbolos.**
                <br>
                **Total na Lista:** <span id="total-input-count">0</span> cartões.
            </div>
        </div>
        <div class="input-controls">
            <h3>Controles</h3>
            <button id="start-check"><i class="fas fa-play"></i> Iniciar Checagem</button>
            <button id="stop-check" disabled><i class="fas fa-stop"></i> Parar Checagem</button>
            <button id="clear-list"><i class="fas fa-trash-alt"></i> Limpar Lista</button>
        </div>
    </div>

    <div class="tab-content" id="checking-content">
        <div class="checking-dashboard">
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-value" id="total-checked-count">0</div>
                    <div class="status-label">Total Checado</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="live-count" style="color: var(--success-color);">0</div>
                    <div class="status-label">Aprovados</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="dead-count" style="color: var(--danger-color);">0</div>
                    <div class="status-label">Reprovados/Erro</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="remaining-count">0</div>
                    <div class="status-label">Restantes</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="speed-count">0.0 c/s</div>
                    <div class="status-label">Velocidade</div>
                </div>
            </div>
            
            <h3>Log de Atividade Recente</h3>
            <div class="realtime-log" id="realtime-log">
                [00:00:00] Aguardando lista de cartões...
            </div>
        </div>
    </div>

    <div class="tab-content" id="live-content">
        <div class="results-panel">
            <h3>Lista de Cartões Aprovados</h3>
            <button id="copy-all-live"><i class="fas fa-copy"></i> Copiar Todos os Cartões Live</button>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Cartão</th>
                        <th>Status</th>
                        <th>Resposta (AUTH|CODE)</th>
                        <th>Detalhes (DECISÃO)</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="live-results-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="tab-content" id="dead-content">
        <div class="results-panel">
            <h3>Lista de Cartões Reprovados/Erro</h3>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Cartão</th>
                        <th>Status</th>
                        <th>Resposta (AUTH|CODE)</th>
                        <th>Detalhes (DECISÃO)</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="dead-results-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const cardListTextarea = document.getElementById('card-list');
        const startCheckButton = document.getElementById('start-check');
        const stopCheckButton = document.getElementById('stop-check');
        const clearListButton = document.getElementById('clear-list');
        const totalInputCount = document.getElementById('total-input-count');
        const copyAllLiveButton = document.getElementById('copy-all-live'); // NOVO: Botão de Copiar Todos
        
        // Elementos de Status
        const totalCheckedEl = document.getElementById('total-checked-count');
        const liveCountEl = document.getElementById('live-count');
        const deadCountEl = document.getElementById('dead-count');
        const remainingCountEl = document.getElementById('remaining-count');
        const speedCountEl = document.getElementById('speed-count');
        const realtimeLogEl = document.getElementById('realtime-log');

        const liveResultsBody = document.getElementById('live-results-body');
        const deadResultsBody = document.getElementById('dead-results-body');

        // Spans nos botões de aba
        const checkingSpan = document.getElementById('checking-span');
        const liveSpan = document.getElementById('live-span');
        const deadSpan = document.getElementById('dead-span');

        let cardsToProcess = [];
        let liveCardsRaw = []; // NOVO: Array para armazenar os cartões LIVE brutos para cópia em massa
        let liveCount = 0;
        let deadCount = 0;
        let totalChecked = 0;
        let checkingInProgress = false;
        let startTime = 0;
        let processInterval = 3000; 
        let scheduleTimeoutId = null; 

        // ------------------ Funções de UI ------------------

        // Alternância de Abas
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        // Contagem de Cartões na Lista
        cardListTextarea.addEventListener('input', () => {
            const cards = cardListTextarea.value.trim().split('\n').filter(line => line.trim() !== '');
            totalInputCount.textContent = cards.length;
        });

        clearListButton.addEventListener('click', () => {
            cardListTextarea.value = '';
            totalInputCount.textContent = '0';
        });

        /**
         * FUNÇÃO CHAVE: Reseta a interface e PARA o agendamento imediatamente.
         */
        function stopCheckingProcess(interrupted = false) {
            
            if (scheduleTimeoutId !== null) {
                clearTimeout(scheduleTimeoutId); // *** PARADA IMEDIATA ***
                scheduleTimeoutId = null;
            }

            // Reset de variáveis de estado
            checkingInProgress = false;
            startTime = 0;
            
            // Habilita/Desabilita os botões para deixar a página pronta
            startCheckButton.textContent = 'Reiniciar Checagem';
            startCheckButton.disabled = false;
            stopCheckButton.disabled = true; 
            cardListTextarea.disabled = false;
            clearListButton.disabled = false;
            speedCountEl.textContent = '0.0 c/s';
            
            const message = interrupted ? 
                `Checagem PARADA MANUALMENTE. ${cardsToProcess.length} cartões restantes. Interface liberada para atualizar.` :
                'Checagem finalizada!';
                
            logEvent(message, 'INFO');
        }

        stopCheckButton.addEventListener('click', () => stopCheckingProcess(true));

        // ------------------ Funções de Checagem e Salvamento ------------------

        /**
         * NOVO: Envia o cartão Live para um script PHP salvar em lives.txt
         * @param {string} card - O cartão completo (cc|mm|yyyy|cvv)
         */
        async function saveLiveCardToFile(card) {
            try {
                const formData = new FormData();
                formData.append('card', card);

                // Chama o novo script de salvamento
                const response = await fetch('save_live.php', { 
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.text();
                if (response.ok && result.trim() === 'SUCCESS') {
                    logEvent(`[AUTO-SAVE] Live salvo em lives.txt.`, 'INFO');
                } else {
                    logEvent(`[AUTO-SAVE] ERRO ao salvar Live em lives.txt. Resposta: ${result.substring(0, 50)}...`, 'ERRO');
                }
            } catch (error) {
                logEvent(`[AUTO-SAVE] ERRO FATAL (JS/NETWORK) ao salvar Live: ${error.message}`, 'ERRO');
            }
        }


        function updateSpeed() {
            if (checkingInProgress && startTime > 0) {
                const elapsedSeconds = (Date.now() - startTime) / 1000;
                const speed = totalChecked / elapsedSeconds;
                speedCountEl.textContent = `${speed.toFixed(1)} c/s`;
            } else {
                speedCountEl.textContent = '0.0 c/s';
            }
        }

        function updateCounters() {
            totalCheckedEl.textContent = totalChecked;
            liveCountEl.textContent = liveCount;
            deadCountEl.textContent = deadCount;
            remainingCountEl.textContent = cardsToProcess.length;
            checkingSpan.textContent = cardsToProcess.length;
            liveSpan.textContent = liveCount;
            deadSpan.textContent = deadCount;
        }

        function logEvent(message, status = 'INFO') {
            const now = new Date();
            const time = now.toLocaleTimeString('pt-BR', { hour12: false });
            
            let color = '#ccc';
            if (status === 'APROVADO') color = '#28a745';
            if (status === 'REPROVADO') color = '#DC143C';
            if (status.startsWith('ERRO')) color = '#ffc107';

            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${time}] <span style="color: ${color};">${status}</span>: ${message}`;
            realtimeLogEl.prepend(logEntry); // Adiciona no topo
            
            if (realtimeLogEl.children.length > 100) {
                realtimeLogEl.removeChild(realtimeLogEl.lastChild);
            }
        }
        
        function copyToClipboard(text, isBulk = false) {
            navigator.clipboard.writeText(text).then(() => {
                const logMessage = isBulk ? 
                    `Todos os ${liveCardsRaw.length} cartões Live copiados para a área de transferência.` :
                    `Cartão copiado: ${text.substring(0, 6)}...`;
                logEvent(logMessage, 'INFO');
            }).catch(err => {
                console.error('Falha ao copiar:', err);
            });
        }
        
        // NOVO: Event listener para o botão de Copiar Todos
        copyAllLiveButton.addEventListener('click', () => {
            if (liveCardsRaw.length === 0) {
                logEvent('Nenhum cartão Live para copiar.', 'INFO');
                return;
            }
            // liveCardsRaw já contém os cartões brutos
            const allCards = liveCardsRaw.join('\n');
            copyToClipboard(allCards, true);
        });


        function addResultToTable(cardLine, result) {
            const parts = cardLine.split(' DECISÃO DA TRANSAÇÃO: ');
            const cardInfo = result.rawCard.split('|'); // Usa o rawCard para extrair as partes
            let gatewayDetails = parts.length > 1 ? parts[1] : cardLine; 

            let status = result.status; 
            if (gatewayDetails.includes('*** FORÇADO LIVE:')) {
                gatewayDetails = gatewayDetails.replace('*** FORÇADO LIVE:', '').trim();
            }

            const isLive = status === 'APROVADO';

            const tbody = isLive ? liveResultsBody : deadResultsBody;
            const statusClass = isLive ? 'live-badge' : 'dead-badge';
            
            const newRow = tbody.insertRow(0);
            
            // Coluna 1: Cartão 
            const cardNumber = cardInfo[0];
            const expMonth = cardInfo[1];
            const expYear = cardInfo[2];
            const cvv = cardInfo[3];
            const displayCard = `${cardNumber.substring(0, 6)} **** **** ${cardNumber.substring(12)} | ${expMonth}/${expYear} | ${cvv}`;
            newRow.insertCell(0).textContent = displayCard;
            
            // Coluna 2: Status
            newRow.insertCell(1).innerHTML = `<span class="status-badge ${statusClass}">${status}</span>`;
            
            // Coluna 3: Resposta (AUTH|CODE)
            const authMatch = gatewayDetails.match(/AUTH: ([^ ]+)/);
            const codeMatch = gatewayDetails.match(/CODE: ([^ ]+)/);
            const authCode = `AUTH: ${authMatch ? authMatch[1] : 'N/A'} | CODE: ${codeMatch ? codeMatch[1] : 'N/A'}`;
            newRow.insertCell(2).textContent = authCode;

            // Coluna 4: Detalhes (DECISÃO + MESSAGE)
            const decisionMatch = gatewayDetails.match(/^([^ ]+)/);
            const messageMatch = gatewayDetails.match(/- ([^-]+) - CODE:/); 
            
            let details = 'N/A';
            if (decisionMatch && messageMatch) {
                details = `${decisionMatch[1]} - ${messageMatch[1].trim()}`;
            } else {
                details = gatewayDetails.substring(0, 100) + '...';
            }
            newRow.insertCell(3).textContent = details;

            // Coluna 5: Ação (Botão Copiar Individual)
            const actionCell = newRow.insertCell(4);
            const fullCardRaw = result.rawCard;
            const copyButton = document.createElement('button');
            copyButton.innerHTML = `<i class="fas fa-copy"></i> Copiar`;
            copyButton.style.cssText = 'background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 0.9rem;';
            copyButton.addEventListener('click', () => copyToClipboard(fullCardRaw));
            actionCell.appendChild(copyButton);


            // Animação de Pulse
            const counterEl = isLive ? liveCountEl : deadCountEl;
            const pulseClass = isLive ? 'success-pulse' : 'danger-pulse';
            counterEl.classList.add(pulseClass);
            setTimeout(() => counterEl.classList.remove(pulseClass), 300);
        }

        async function processCard(card) {
            totalChecked++;
            
            let status = 'REPROVADO';
            let message = 'ERRO DE COMUNICAÇÃO';
            let responseText = '';

            try {
                const formData = new FormData();
                formData.append('card', card);

                const response = await fetch('php.php', {
                    method: 'POST',
                    body: formData
                });
                
                responseText = await response.text();
                const responseLines = responseText.trim().split('\n');
                
                if (responseLines.length >= 2) {
                    status = responseLines[0].trim(); 
                    message = responseLines[1].trim(); 

                    const upperMessage = message.toUpperCase();

                    if (upperMessage.includes('AUTH: 007') || upperMessage.includes('AUTH: 000') || upperMessage.includes('000 007') || upperMessage.includes('000 83 82')) {
                        status = 'APROVADO'; 
                        message = `*** FORÇADO LIVE: ${message}`; 
                    }

                } else {
                    message = `ERRO: Resposta incompleta do PHP. ${responseText.substring(0, 50)}...`;
                }

            } catch (error) {
                message = `ERRO FATAL (JS/NETWORK): ${error.message}`;
                status = 'REPROVADO';
            }

            if (status === 'APROVADO') {
                liveCount++;
                liveCardsRaw.unshift(card); // Armazena o cartão bruto
                logEvent(`Cartão ${card.substring(0, 4)}... ${message}`, 'APROVADO');
                
                // *** CHAMADA PARA SALVAMENTO AUTOMÁTICO ***
                saveLiveCardToFile(card);

            } else {
                deadCount++;
                logEvent(`Cartão ${card.substring(0, 4)}... ${message}`, 'REPROVADO');
            }

            // Passa o cartão bruto (card) para a função de tabela
            addResultToTable(message, { status: status, fullResponse: responseText, rawCard: card });
            updateCounters();
            updateSpeed();
        }

        /**
         * Agendador recursivo para rodar um teste a cada 'processInterval' segundos.
         */
        function scheduleNextCard() {
            if (cardsToProcess.length > 0 && checkingInProgress) {
                const card = cardsToProcess.pop();

                // Dispara a checagem, mas não espera.
                processCard(card).catch(err => {
                    logEvent(`Erro ao processar cartão (async): ${err.message}`, 'ERRO');
                }); 

                // Agenda o próximo cartão e armazena o ID
                scheduleTimeoutId = setTimeout(scheduleNextCard, processInterval); 
            } else {
                // Fim da lista. Chama a função de parada para resetar o estado.
                stopCheckingProcess();
            }
        }

        // Função principal de Checagem (Inicia o agendamento)
        function startCheckingProcess() {
            if (checkingInProgress) return;

            // REGEX MODIFICADO: Aceita 3 a 4 caracteres alfanuméricos/símbolos no CVV.
            const cards = cardListTextarea.value.trim().split('\n')
                .map(line => line.trim())
                .filter(line => line.match(/^(\d{13,19})\|(\d{1,2})\|(\d{2,4})\|([a-zA-Z0-9!@#$%^&*()_+=\[\]{};':"\\|,.<>\/?~`]{3,4})$/));
            
            if (cards.length === 0) {
                logEvent('Nenhum cartão válido na lista. Verifique o formato.', 'ERRO');
                return;
            }

            cardsToProcess = cards.reverse(); 
            liveCount = 0;
            deadCount = 0;
            totalChecked = 0;
            liveCardsRaw = []; // Limpa o array de cartões Live brutos para a nova rodada
            
            realtimeLogEl.innerHTML = '';
            liveResultsBody.innerHTML = '';
            deadResultsBody.innerHTML = '';
            
            updateCounters();
            checkingInProgress = true;
            startTime = Date.now();
            
            // Habilita/Desabilita os botões
            startCheckButton.textContent = 'Checando...';
            startCheckButton.disabled = true;
            stopCheckButton.disabled = false; 
            cardListTextarea.disabled = true;
            clearListButton.disabled = true;

            logEvent(`Iniciando checagem de ${cardsToProcess.length} cartões. Um teste a cada ${processInterval/1000}s.`, 'INFO');

            scheduleNextCard();
        }

        startCheckButton.addEventListener('click', startCheckingProcess);
        
        cardListTextarea.dispatchEvent(new Event('input'));
        updateCounters(); 

        logEvent('Sistema pronto. Cole a lista de cartões na primeira aba e clique em Iniciar Checagem.', 'INFO');
    });
</script>

</body>
</html>